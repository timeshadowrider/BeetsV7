# ============================================================================
# BEETS CONFIGURATION - v7.5
# Key changes from v7.4:
# - singleton: no  (was: yes) — CRITICAL FIX: was treating every file as a
#   standalone single, destroying album matching
# - fingerprint: no (was: yes) — redundant, fingerprint_all.py already does this
# - incremental: yes (was: no) — track processed files to avoid re-scanning
# - inline fields renamed to albumartist_clean/artist_clean — prevents
#   mangling real tags during MusicBrainz matching
# ============================================================================

directory: /music/library
library: /data/library.db

ui:
  color: yes

asciify_paths: no
per_disc_numbering: no
threaded: yes
original_date: yes

paths:
  default: $albumartist/($year) $album%if{$albumdisambig, [$albumdisambig]}/$track $title
  singleton: Non-Album/$artist/($year) Singles/$title
  comp: Compilations/($year) $album%if{$albumdisambig, [$albumdisambig]}/$track $title

# ----------------------------------------------------------------------------
# IMPORT SETTINGS
# ----------------------------------------------------------------------------
import:
  incremental: yes      # was: no — now tracks processed files, avoids re-scanning
  move: yes
  copy: no
  write: yes
  log: /data/last_beets_imports.log
  detail: yes
  duplicate_action: skip
  timid: no
  autotag: yes
  fingerprint: no       # was: yes — redundant, fingerprint_all.py handles this
                        # and double-fingerprinting causes AcoustID rate-limit failures
  art: yes
  group_albums: yes
  resume: no
  singleton: no         # was: yes — CRITICAL FIX. 'yes' treated every file as a
                        # standalone single, bypassing album matching entirely.
                        # This was the primary cause of failed_imports.

  # KEY FIXES - was 'skip', now 'asis'
  # 'asis' imports with existing file tags rather than abandoning to failed_imports
  quiet_fallback: asis
  none_rec_action: asis

# ----------------------------------------------------------------------------
# MATCHING & METADATA
# ----------------------------------------------------------------------------
match:
  unmatched_tracks: keep

  # Lowered from 0.25 to 0.10 - less strict, fewer false failures
  strong_rec_thresh: 0.10

  distance_weights:
    track_title: 1.0
    track_artist: 1.0
    album: 1.0
    track_index: 1.0
    track_length: 1.0
    data_source: 0.0
    missing_tracks: 0.2

tiebreak:
  bitrate: desc
  format: [FLAC, ALAC, AAC, MP3]
  bitdepth: desc
  samplerate: desc

logging:
  level: INFO
  handlers:
    file:
      filename: /data/beets.log
      format: '%(asctime)s [%(levelname)s] %(message)s'

# ----------------------------------------------------------------------------
# PLUGINS
# ----------------------------------------------------------------------------
plugins:
  - info
  - edit
  - mbsync
  - missing
  - inline
  - fromfilename
  - scrub
  - zero
  - the
  - ftintitle
  - lastgenre
  - albumtypes
  - discogs
  - musicbrainz
  - lyrics
  - fetchart
  - embedart
  - plexupdate
  - mpdupdate
  - smartplaylist

# ----------------------------------------------------------------------------
# INLINE METADATA NORMALIZATION
# FIX: Renamed from 'albumartist'/'artist' to 'albumartist_clean'/'artist_clean'
# Previously these shadowed the real tags during MusicBrainz matching, causing
# collaborative artists like "Simon & Garfunkel" to be looked up as just "Simon".
# The _clean variants are available for path templates or display but do NOT
# interfere with the import matching pipeline.
# ----------------------------------------------------------------------------
inline:
  albumartist_clean: |
    import re
    normalized = re.sub(
        r'\s*(?:&|and|x|X|feat\.?|ft\.?|featuring|with|vs\.?)\s*',
        '|||',
        albumartist,
        flags=re.IGNORECASE
    )
    return normalized.split('|||')[0].strip()

  artist_clean: |
    import re
    normalized = re.sub(
        r'\s*(?:&|and|x|X|feat\.?|ft\.?|featuring|with|vs\.?)\s*',
        '|||',
        artist,
        flags=re.IGNORECASE
    )
    return normalized.split('|||')[0].strip()

# ----------------------------------------------------------------------------
# ARTWORK
# ----------------------------------------------------------------------------
embedart:
  auto: yes
  ifempty: yes
  remove_art_file: no
  maxwidth: 1200

fetchart:
  minwidth: 500
  maxwidth: 1200
  enforce_ratio: 10px
  auto: yes
  art_filename: cover
  sources: [coverart, filesystem, lastfm, fanarttv]
  lastfm_key: 91521efedd7bca03e6e8d4aa570eb61b
  fanarttv_key: 7cf7143c127fe59f11836a438237b4cb
  store_source: yes
  cover_names: [cover, folder, front]

# ----------------------------------------------------------------------------
# FEATURED ARTISTS IN TITLE
# ----------------------------------------------------------------------------
ftintitle:
  auto: yes
  format: "(feat. {0})"

# ----------------------------------------------------------------------------
# GENRE
# ----------------------------------------------------------------------------
lastgenre:
  auto: yes
  count: 4
  prefer_specific: yes
  force: yes
  source: track
  separator: "; "
  fallback: ""

# ----------------------------------------------------------------------------
# DISCOGS
# ----------------------------------------------------------------------------
discogs:
  user_token: nSxVRTjzwbgIxzManORnSuDCIUEqouNYUcKymrHv

# ----------------------------------------------------------------------------
# LYRICS
# ----------------------------------------------------------------------------
lyrics:
  auto: yes
  sources: [genius, lrclib, google]
  genius_api_key: "-nO5NHAXNudMKIa7syQBkGDjFWhfy1-v5dmYIGS76USKyqeMfvZZnV0-1dCtpHHg"

# ----------------------------------------------------------------------------
# MPD
# ----------------------------------------------------------------------------
mpd:
  host: 10.0.0.102
  port: 6600

# ----------------------------------------------------------------------------
# PLEX
# ----------------------------------------------------------------------------
plex:
  host: 10.0.0.100
  port: 32400
  token: rEn12-HUTx1TsfYDyDpz

# ----------------------------------------------------------------------------
# SUBSONIC (disabled)
# ----------------------------------------------------------------------------
#subsonic:
#  host: http://10.0.0.100
#  port: 4533
#  user: timeshadowrider
#  pass: 'An|t@theR@bb|t'
#  contextpath: /

# ----------------------------------------------------------------------------
# SMART PLAYLISTS
# ----------------------------------------------------------------------------
smartplaylist:
  relative_to: /music/library
  playlist_dir: /music/playlists
  playlists:
    - name: All_Music.m3u
      query: ""
    - name: Recent_Additions.m3u
      query: "added:-30d.."
    - name: High_Quality.m3u
      query: "bitrate:320000.."

# ----------------------------------------------------------------------------
# ZERO
# ----------------------------------------------------------------------------
zero:
  fields: [art]